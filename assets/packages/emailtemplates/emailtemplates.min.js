var LS=LS||{onDocumentReady:{}},PrepEmailTemplates=function(){var currentTarget=null,KCFinder_callback=function(url){console.ls.log("target",currentTarget),console.ls.log("$(currentTarget).closest('.selector__table-container')",$(currentTarget).closest(".selector__table-container")),$(currentTarget).closest(".selector__table-container").hasClass("hidden")&&$(currentTarget).closest(".selector__table-container").removeClass("hidden"),addAttachment(currentTarget,url),window.KCFinder=null},editAttachmentRelevance=function(e){e.preventDefault();var target=$(this).parents("tr").find("input.relevance"),span=$(this).parents("tr").find("span.relevance");$("#attachment-relevance-editor textarea").val($(target).val()),$("#attachment-relevance-editor").modal({backdrop:"static",keyboard:!1}),$("#attachment-relevance-editor .btn-success").one("click",function(event){var newRelevanceEquation=$("#attachment-relevance-editor textarea").val();$(target).val(newRelevanceEquation),newRelevanceEquation.length>50?$(span).html(newRelevanceEquation.replace(/(\r\n|\n|\r)/gm,"").substr(0,47)+"..."):$(span).html(newRelevanceEquation),$("#attachment-relevance-editor").modal("hide")})},addAttachment=function(target,url,relevance,size){if(void 0===relevance)relevance="1";if(void 0===size)size="-";var filename=decodeURIComponent(url.replace(/^.*[\\\/]/,"")),baserow=$("#rowTemplate").find("tbody").html();if($(target).is("table")){var newrow=$(baserow).clone(),templatetype=$(target).attr("data-template"),index=$(target).find("tr").length-1;relevance.length>50?$(newrow).find("span.relevance").html(relevance.replace(/(\r\n|\n|\r)/gm,"").substr(0,47)+"..."):$(newrow).find("span.relevance").html(relevance),$(newrow).find("input.relevance").val(relevance).attr("name","attachments"+templatetype+"["+index+"][relevance]"),$(newrow).find("input.filename").attr("name","attachments"+templatetype+"["+index+"][url]"),$(newrow).appendTo($(target).find("tbody")),$("#kc-modal-open").modal("hide")}else newrow=target;$("span.edit-relevance-equation").off("click").on("click",editAttachmentRelevance),$(".btnattachmentremove").off("click").on("click",removeAttachment),$("span.filename").off("click").on("click",function(e){e.preventDefault();var target=$(this).parents("tr");openKCFinder_singleFile(target)}),$(newrow).find("span.filesize").text(formatFileSize(size)),$(newrow).find("span.filename").text(filename),$(newrow).find("input.filename").val(url)},removeAttachment=function(e){e.preventDefault(),$(this).parents("tr").remove()},formatFileSize=function(bytes){return bytes>=1e6?(bytes/1e6).toFixed(2)+"MB":bytes<1e6?(bytes/1e3).toFixed(0)+"KB":bytes},openKCFinder_singleFile=function(target,uri){currentTarget=target,window.KCFinder={},window.KCFinder.target=target,window.KCFinder.callBack=KCFinder_callback,$("#kc-modal-open").find("iframe").attr("src",uri),$("#kc-modal-open").modal("show")};return{init:function(modal_id){$(".fillin").on("click",function(e){e.preventDefault;var newval=$(this).attr("data-value"),target=$("#"+$(this).attr("data-target"));$(target).val(newval);try{updateCKeditor($(this).attr("data-target"),newval)}catch(err){}}),$("button.add-attachment").off("click.emailtemplates").on("click.emailtemplates",function(e){e.preventDefault();var target=$($(this).data("target")),ckTarget=$(this).data("ck-target"),uri=LS.data.baseUrl+"/third_party/kcfinder/browse.php?opener=custom&type=files&CKEditor="+ckTarget+"&langCode="+sKCFinderLanguage;openKCFinder_singleFile(target,uri)}),$("#kc-modal-open").modal({backdrop:!1,show:!1}),$("#kc-modal-open").on("hidden.bs.modal",function(){$(this).find("iframe").attr("src","about:blank")})},currentTarget:currentTarget,addAttachment:addAttachment}};
